import java.io.IOException
import java.io.OutputStream
import org.gradle.api.GradleException
import org.gradle.api.provider.ValueSource
import org.gradle.api.provider.ValueSourceParameters
import org.gradle.process.ExecOperations

class NullOutputStream extends OutputStream {
    @Override
    public void write(int i) throws IOException { }
    @Override
    public void write(byte[] b) throws IOException { }
    @Override
    public void write(byte[] b, int off, int len) throws IOException { }

    static final OutputStream INSTANCE = new NullOutputStream()
}

abstract class ExecValueSource implements ValueSource<String, ValueSourceParameters.None> {
    @Inject
    abstract ExecOperations getExecOperations()

    abstract List<String> getCommandLine()

    String obtain() {
        ByteArrayOutputStream output = new ByteArrayOutputStream()
        execOperations.exec {
            it.commandLine getCommandLine()
            it.standardOutput = output
            it.errorOutput = NullOutputStream.INSTANCE
            it.ignoreExitValue = true
        }
        return output.toString().trim()
    }
}

abstract class RosettaValueSource extends ExecValueSource {
    List<String> getCommandLine() {
        return ["sysctl", "-in", "sysctl.proc_translated"]
    }
}

class Const {
    static final Set<String> RECOMMANDED_JVM_VERSIONS = ["21"]
}

def MINIMUM_JVM_VERSION = settings.getProperty("build.jvmtarget.host")
Const.RECOMMANDED_JVM_VERSIONS.add(MINIMUM_JVM_VERSION)

def checkJvmRequires() {
    def jvmVersion = System.getProperty("java.specification.version")
    if (!Const.RECOMMANDED_JVM_VERSIONS.contains(jvmVersion)) {
        throw new GradleException(
            "Use Jetbrain Runtime 17 which is included on Android Studio or JDK 17 LTS version"
        )
    }

    if (jvmVersion.equals("21")) {
        logger.warn("You must use JDK 21 from https://github.com/ganadist/graalvm-ce-builds/releases/tag/2023-10-24")
    }
}

def checkRosetta() {
    // https://developer.apple.com/documentation/apple-silicon/about-the-rosetta-translation-environment#Determine-Whether-Your-App-Is-Running-as-a-Translated-Binary
    if (System.getProperty("os.name").contains("OS X")) {
        def rosettaProvider = providers.of(RosettaValueSource.class) {}
        def rosettaEnabled = rosettaProvider.get()

        if (rosettaEnabled == "1") {
            throw new GradleException(
                "Your build is running under rosetta. Please setup your Android Studio properly"
            )
        }
    }
}

def checkBuildRequires() {
    if (!getProperty("build.check.requires").toBoolean()) {
        return
    }
    checkJvmRequires()
    checkRosetta()
}

checkBuildRequires()
